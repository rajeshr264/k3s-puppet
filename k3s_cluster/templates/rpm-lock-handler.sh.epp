#!/bin/bash
# rpm-lock-handler.sh.epp - Handle RPM lock issues before K3S installation
# Generated by Puppet - DO NOT EDIT MANUALLY

# Note: Not using 'set -e' to allow graceful handling of non-critical errors

echo "🔍 Checking for RPM transaction locks..."

# Function to check if RPM is locked
check_rpm_lock() {
    if fuser /var/lib/rpm/.rpm.lock >/dev/null 2>&1; then
        return 0  # locked
    else
        return 1  # not locked
    fi
}

# Function to wait for RPM lock release
wait_for_rpm_lock() {
    local timeout=300  # 5 minutes
    local elapsed=0
    
    while check_rpm_lock; do
        if [ $elapsed -ge $timeout ]; then
            echo "⏰ Timeout waiting for RPM lock to be released"
            echo "🧹 Attempting to clean up stale lock files..."
            rm -f /var/lib/rpm/.rpm.lock 2>/dev/null || echo "Could not remove .rpm.lock (may not exist)"
            rm -f /var/lib/rpm/.dbenv.lock 2>/dev/null || echo "Could not remove .dbenv.lock (may not exist)"
            break
        fi
        echo "🔒 RPM database is locked, waiting... ($elapsed/$timeout seconds)"
        sleep 10
        elapsed=$((elapsed + 10))
    done
}

# Function to clean up package processes
cleanup_package_processes() {
    echo "🧹 Cleaning up any hanging package processes..."
    
    # Kill hanging package manager processes (ignore errors)
    pkill -f "yum" 2>/dev/null && echo "Killed yum processes" || echo "No yum processes to kill"
    pkill -f "dnf" 2>/dev/null && echo "Killed dnf processes" || echo "No dnf processes to kill"
    pkill -f "rpm" 2>/dev/null && echo "Killed rpm processes" || echo "No rpm processes to kill"
    pkill -f "packagekit" 2>/dev/null && echo "Killed packagekit processes" || echo "No packagekit processes to kill"
    
    # Stop services that might interfere (temporarily)
    if systemctl is-active --quiet packagekit 2>/dev/null; then
        echo "Stopping packagekit service..."
        systemctl stop packagekit 2>/dev/null || echo "Could not stop packagekit service"
    fi
    
    if systemctl is-active --quiet amazon-ssm-agent 2>/dev/null; then
        echo "Stopping amazon-ssm-agent service..."
        systemctl stop amazon-ssm-agent 2>/dev/null || echo "Could not stop amazon-ssm-agent service"
    fi
    
    # Wait for processes to fully stop
    sleep 5
}

# Function to restart services
restart_services() {
    echo "🔄 Restarting system services..."
    
    if systemctl is-enabled --quiet packagekit 2>/dev/null; then
        systemctl start packagekit 2>/dev/null && echo "Restarted packagekit" || echo "Could not restart packagekit"
    fi
    
    if systemctl is-enabled --quiet amazon-ssm-agent 2>/dev/null; then
        systemctl start amazon-ssm-agent 2>/dev/null && echo "Restarted amazon-ssm-agent" || echo "Could not restart amazon-ssm-agent"
    fi
}

# Only run RPM lock handling on RPM-based systems
if command -v rpm >/dev/null 2>&1; then
    echo "📦 RPM-based system detected, checking for locks..."
    
    # Step 1: Wait for any existing RPM operations to complete
    wait_for_rpm_lock
    
    # Step 2: Clean up hanging processes
    cleanup_package_processes
    
    echo "✅ RPM lock handling completed"
    
    # Set up trap to restart services on exit
    trap 'restart_services' EXIT
else
    echo "ℹ️  Non-RPM system, skipping RPM lock checks"
fi

echo "🚀 System ready for K3S installation"

# Always exit successfully unless there's a critical error
exit 0 